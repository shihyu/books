<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>3. ARP數據報格式</title><link rel="stylesheet" href="styles.css" type="text/css" /><meta name="generator" content="DocBook XSL Stylesheets V1.73.2" /><link rel="start" href="index.html" title="Linux C編程一站式學習" /><link rel="up" href="ch36.html" title="第 36 章 TCP/IP協議基礎" /><link rel="prev" href="ch36s02.html" title="2. 乙太網(RFC 894)幀格式" /><link rel="next" href="ch36s04.html" title="4. IP數據報格式" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">3. ARP數據報格式</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch36s02.html">上一頁</a> </td><th width="60%" align="center">第 36 章 TCP/IP協議基礎</th><td width="20%" align="right"> <a accesskey="n" href="ch36s04.html">下一頁</a></td></tr></table><hr /></div><div class="sect1" lang="zh-cn" xml:lang="zh-cn"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id2899750"></a>3. ARP數據報格式</h2></div></div></div><p>在網絡通訊時，源主機的應用程序知道目的主機的IP地址和連接埠號，卻不知道目的主機的硬件地址，而數據包首先是被網卡接收到再去處理上層協議的，如果接收到的數據包的硬件地址與本機不符，則直接丟棄。因此在通訊前必須獲得目的主機的硬件地址。ARP協議就起到這個作用。源主機發出ARP請求，詢問“IP地址是192.168.0.1的主機的硬件地址是多少”，並將這個請求廣播到本地網段（乙太網幀首部的硬件地址填FF:FF:FF:FF:FF:FF表示廣播），目的主機接收到廣播的ARP請求，發現其中的IP地址與本機相符，則發送一個ARP應答數據包給源主機，將自己的硬件地址填寫在應答包中。</p><p>每台主機都維護一個ARP緩存表，可以用arp -a命令查看。緩存表中的表項有過期時間（一般為20分鐘），如果20分鐘內沒有再次使用某個表項，則該表項失效，下次還要發ARP請求來獲得目的主機的硬件地址。想一想，為什麼表項要有過期時間而不是一直有效？</p><p>ARP數據報的格式如下所示（該圖出自<a class="xref" href="bi01.html#bibli.tcpip" title="TCP/IP Illustrated, Volume 1: The Protocols">[<abbr class="abbrev">TCPIP</abbr>]</a>）：</p><div class="figure"><a id="id2899804"></a><p class="title"><b>圖 36.7. ARP數據報格式</b></p><div class="figure-contents"><div><img src="images/tcpip.arpformat.png" alt="ARP數據報格式" /></div></div></div><br class="figure-break" /><p>注意到源MAC地址、目的MAC地址在乙太網首部和ARP請求中各出現一次，對於鏈路層為乙太網的情況是多餘的，但如果鏈路層是其它類型的網絡則有可能是必要的。硬件類型指鏈路層網絡類型，1為乙太網，協議類型指要轉換的地址類型，0x0800為IP地址，後面兩個地址長度對於乙太網地址和IP地址分別為6和4（位元組），op欄位為1表示ARP請求，op欄位為2表示ARP應答。</p><p>下面舉一個具體的例子。</p><p>請求幀如下（為了清晰在每行的前面加了位元組計數，每行16個位元組）：</p><div class="literallayout"><p>乙太網首部（14位元組）<br />
0000: ff ff ff ff ff ff 00 05 5d 61 58 a8 08 06<br />
ARP幀（28位元組）<br />
0000:                                           00 01<br />
0010: 08 00 06 04 00 01 00 05 5d 61 58 a8 c0 a8 00 37<br />
0020: 00 00 00 00 00 00 c0 a8 00 02<br />
填充位（18位元組）<br />
0020:                               00 77 31 d2 50 10<br />
0030: fd 78 41 d3 00 00 00 00 00 00 00 00</p></div><p>乙太網首部：目的主機採用廣播地址，源主機的MAC地址是00:05:5d:61:58:a8，上層協議類型0x0806表示ARP。</p><p>ARP幀：硬件類型0x0001表示乙太網，協議類型0x0800表示IP協議，硬件地址（MAC地址）長度為6，協議地址（IP地址）長度為4，op為0x0001表示請求目的主機的MAC地址，源主機MAC地址為00:05:5d:61:58:a8，源主機IP地址為c0 a8 00 37（192.168.0.55），目的主機MAC地址全0待填寫，目的主機IP地址為c0 a8 00 02（192.168.0.2）。</p><p>由於乙太網規定最小數據長度為46位元組，ARP幀長度只有28位元組，因此有18位元組填充位，填充位的內容沒有定義，與具體實現相關。</p><p>應答幀如下：</p><div class="literallayout"><p>乙太網首部<br />
0000: 00 05 5d 61 58 a8 00 05 5d a1 b8 40 08 06<br />
ARP幀<br />
0000:                                           00 01<br />
0010: 08 00 06 04 00 02 00 05 5d a1 b8 40 c0 a8 00 02<br />
0020: 00 05 5d 61 58 a8 c0 a8 00 37<br />
填充位<br />
0020:                               00 77 31 d2 50 10<br />
0030: fd 78 41 d3 00 00 00 00 00 00 00 00</p></div><p>乙太網首部：目的主機的MAC地址是00:05:5d:61:58:a8，源主機的MAC地址是00:05:5d:a1:b8:40，上層協議類型0x0806表示ARP。</p><p>ARP幀：硬件類型0x0001表示乙太網，協議類型0x0800表示IP協議，硬件地址（MAC地址）長度為6，協議地址（IP地址）長度為4，op為0x0002表示應答，源主機MAC地址為00:05:5d:a1:b8:40，源主機IP地址為c0 a8 00 02（192.168.0.2），目的主機MAC地址為00:05:5d:61:58:a8，目的主機IP地址為c0 a8 00 37（192.168.0.55）。</p><p>思考題：如果源主機和目的主機不在同一網段，ARP請求的廣播幀無法穿過路由器，源主機如何與目的主機通信？</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch36s02.html">上一頁</a> </td><td width="20%" align="center"><a accesskey="u" href="ch36.html">上一級</a></td><td width="40%" align="right"> <a accesskey="n" href="ch36s04.html">下一頁</a></td></tr><tr><td width="40%" align="left" valign="top">2. 乙太網(RFC 894)幀格式 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始頁</a></td><td width="40%" align="right" valign="top"> 4. IP數據報格式</td></tr></table></div></body></html>
